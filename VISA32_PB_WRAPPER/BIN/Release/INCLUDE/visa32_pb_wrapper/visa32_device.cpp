///visa32_device类的实现
/**
 * @file
 * @author  Cui Wei <cuiwei_cv@163.com>
 * @version 1.0
 *
 * @section LICENSE
 *
 * This program is not free software, and you must pay for it!
 *
 * @section DESCRIPTION
 *
 * visa32_device类的定义
 */
//
//
//  Generated by StarUML(tm) C++ Add-In
//
//  @ Project : VISA32_PB_WRAPPER_CLASS
//  @ File Name : visa32_device.cpp
//  @ Date : 2013/6/17
//  @ Author : cv
//
//

#include	"visa32_device.h"									//包含自已的头文件
#include	"visa/visa.h"										//使用了ni-visa的一些函数
#include	"VISA32_PB_WRAPPER_DLL.h"			//VISA32_PB_WRAPPER DLL header file

visa32_device::visa32_device()	:	device_rscs(NULL), device_res(0), visa_default(0), health(false){
	device_rscs	=	new char[1024]();	//足够大的heap空间，与对象的生命周期一样长

	strcpy(device_rscs, "USB0::0x0957::0x0607::MY47013374::INSTR");
	viOpenDefaultRM(&visa_default);
}

visa32_device::~visa32_device() {
	viClose(visa_default);
	delete	[]	device_rscs;
}

bool visa32_device::select_visa_device() const{
	return	VISA32_PB_WRAPPER_DLL::select_visa_device(device_rscs);
}

bool visa32_device::select_visa_serialport() const{
	return	VISA32_PB_WRAPPER_DLL::select_visa_serialport(device_rscs);
}

bool visa32_device::select_visa_usb_device() const{
	return	VISA32_PB_WRAPPER_DLL::select_visa_usb_device(device_rscs, 0x0, 0x0);
}

bool visa32_device::select_visa_pci_pxi_card() const{
	return	VISA32_PB_WRAPPER_DLL::select_visa_pci_pxi_card(device_rscs, 0x0, 0x0);
}

bool visa32_device::select_visa_gpib_device() const{
	return	VISA32_PB_WRAPPER_DLL::select_visa_gpib_device(device_rscs);
}

bool visa32_device::select_visa_lxi_device() const{
	return	VISA32_PB_WRAPPER_DLL::select_visa_lxi_device(device_rscs);
}

bool visa32_device::select_visa_bus(DWORD mask) const{
	return	VISA32_PB_WRAPPER_DLL::select_visa_bus(device_rscs, mask);
}

bool visa32_device::init() {
	ViStatus	result;

	if (false	==	health)
	{
		result	=	viOpen(visa_default, device_rscs, VI_NO_LOCK, 1000, &device_res);
		if (VI_SUCCESS	!=	result)
		{
			MessageBox(GetFocus(), "error open resource from visa32_standalone_device", "cv", MB_ICONERROR|MB_SYSTEMMODAL);
			health	=	false;
			return	false;
		}
		else
		{
			viInstallHandler(device_res, VI_EVENT_EXCEPTION, VISA32_PB_WRAPPER_DLL::visa32_error_handler, VI_NULL);
			viEnableEvent(device_res, VI_EVENT_EXCEPTION, VI_HNDLR, VI_NULL);
			health	=	true;
			return	true;
		}
	}
	else
	{
		MessageBox(GetFocus(), "already inited card!", "cv", MB_ICONERROR|MB_SYSTEMMODAL);
		health	=	true;
		return	false;
	}
}

bool visa32_device::release() {
	if (true	==	health)
	{
		viDisableEvent(device_res, VI_ALL_ENABLED_EVENTS, VI_ALL_MECH);
		viUninstallHandler(device_res, VI_EVENT_EXCEPTION, VISA32_PB_WRAPPER_DLL::visa32_error_handler, VI_NULL);
		viClose(device_res);
		health	=	false;
		return	true;
	}
	else
	{
		MessageBox(GetFocus(), "there is nothing to release. ", "cv", MB_ICONINFORMATION|MB_SYSTEMMODAL);
		return	false;
	}
}

void visa32_device::set_device_rscs(const	char* const	param1) const{
	strcpy(device_rscs, param1);
}

void visa32_device::visa_interactive_io() const{
	VISA32_PB_WRAPPER_DLL::visa_interactive_io(device_res);
}

