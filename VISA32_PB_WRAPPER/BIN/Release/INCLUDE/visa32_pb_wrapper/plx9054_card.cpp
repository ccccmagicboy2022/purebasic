//
//
//  Generated by StarUML(tm) C++ Add-In
//
//  @ Project : VISA32_PB_WRAPPER_CLASS
//  @ File Name : plx9054_card.cpp
//  @ Date : 2013/6/26
//  @ Author : cv
//
//

#include "plx9054_card.h"
#include "visa/visa.h"
#include "VISA32_PB_WRAPPER_DLL.h"

plx9054_card::plx9054_card()	:	visa_default(0), card_res(0), bit_num(0), eeprom_addr(0), health(false)
{
	viOpenDefaultRM(&visa_default);
}

plx9054_card::~plx9054_card()
{
	viClose(visa_default);
}

bool	plx9054_card::release()
{
	if (true	==	health)
	{
		viDisableEvent(card_res, VI_ALL_ENABLED_EVENTS, VI_ALL_MECH);
		viUninstallHandler(card_res, VI_EVENT_EXCEPTION, VISA32_PB_WRAPPER_DLL::visa32_error_handler, VI_NULL);
		viClose(card_res);
		health	=	false;
		return	true;
	}
	else
	{
		//MessageBox(GetFocus(), "there is nothing to release. ", "cv", MB_ICONINFORMATION|MB_SYSTEMMODAL);
		return	false;
	}
}

bool	plx9054_card::select_visa_pci_pxi_card()	const
{
	return	set_card_rscs(0x0, 0x0);
}

bool	plx9054_card::init()
{
	ViStatus	result;

	if (false	==	health)
	{
		result	=	viOpen(visa_default, get_card_rscs(), VI_NO_LOCK, 1000, &card_res);
		if (VI_SUCCESS	!=	result)
		{
			MessageBox(GetFocus(), "error open resource from plx9054_device class", "cv", MB_ICONERROR|MB_SYSTEMMODAL);
			return	false;
		}
		else
		{
			viInstallHandler(card_res, VI_EVENT_EXCEPTION, VISA32_PB_WRAPPER_DLL::visa32_error_handler, VI_NULL);
			viEnableEvent(card_res, VI_EVENT_EXCEPTION, VI_HNDLR, VI_NULL);
			health	=	true;
			return	true;
		}
	}
	else
	{
		MessageBox(GetFocus(), "already inited card!", "cv", MB_ICONERROR|MB_SYSTEMMODAL);
		return	false;
	}
}

void	plx9054_card::plx9054_reset_card()	const
{
	VISA32_PB_WRAPPER_DLL::plx9054_reset_card(card_res);
}

DWORD	plx9054_card::plx9054_read_eeprom_32()	const
{
	DWORD	data	=	0;
	VISA32_PB_WRAPPER_DLL::plx9054_read_eeprom_32(card_res, eeprom_addr, &data);
	return	data;
}

void	plx9054_card::plx9054_write_eeprom_32(DWORD	data)	const
{
	VISA32_PB_WRAPPER_DLL::plx9054_write_eeprom_32(card_res, eeprom_addr, data);
}

bool	plx9054_card::check_plx9054_eeprom_is_cv_style()	const
{
	return	VISA32_PB_WRAPPER_DLL::check_plx9054_eeprom_is_cv_style(card_res);
}

DWORD	plx9054_card::get_plx9054_fpga_logic_version()	const
{
	return	VISA32_PB_WRAPPER_DLL::get_plx9054_fpga_logic_version(card_res);
}

bool	plx9054_card::burn_cv_style_eeprom_for_this_plx9054()	const
{
	DWORD	id	=	0;
	VISA32_PB_WRAPPER_DLL::plx9054_read_eeprom_32(card_res, 0x44, &id);
	VISA32_PB_WRAPPER_DLL::hex_input(&id, 32);
	return	VISA32_PB_WRAPPER_DLL::burn_cv_style_eeprom_for_this_plx9054(card_res, id);
}

void	plx9054_card::memory_bit_clear()	const
{
	VISA32_PB_WRAPPER_DLL::memory_bit_clear(card_res, get_mem_bar(), get_mem_offset(), bit_num);
}

void	plx9054_card::memory_bit_set()	const
{
	VISA32_PB_WRAPPER_DLL::memory_bit_set(card_res, get_mem_bar(), get_mem_offset(), bit_num);
}

bool	plx9054_card::memory_bit_test()	const
{
	return	VISA32_PB_WRAPPER_DLL::memory_bit_test(card_res, get_mem_bar(), get_mem_offset(), bit_num);
}

void	plx9054_card::set_bit_num(DWORD	param1)
{
	bit_num	=	param1;
}

bool	plx9054_card::set_bit_num()
{
	return	VISA32_PB_WRAPPER_DLL::dec_input(&bit_num);
}

void	plx9054_card::set_eeprom_addr(DWORD	param1)
{
	eeprom_addr	=	param1;
}

bool	plx9054_card::set_eeprom_addr()
{
	return	VISA32_PB_WRAPPER_DLL::hex_input(&eeprom_addr, 16);
}

DWORD	plx9054_card::dram_stress_testing(DWORD param1, DWORD	param2)	const
{
	return	VISA32_PB_WRAPPER_DLL::dram_stress_testing(card_res, get_mem_bar(), get_mem_offset(), get_mem_size(), param1, param2);
}

WORD plx9054_card::get_card_slot()
{
	WORD	temp;
	viGetAttribute(get_card_res(), VI_ATTR_SLOT, &temp);
	return	temp;
}

void plx9054_card::memory_bit_clear(DWORD bar, DWORD offset, DWORD bit_num)	const
{
	VISA32_PB_WRAPPER_DLL::memory_bit_clear(card_res, bar, offset, bit_num);
}

void plx9054_card::memory_bit_set(DWORD bar, DWORD offset, DWORD bit_num)	const
{
	VISA32_PB_WRAPPER_DLL::memory_bit_set(card_res, bar, offset, bit_num);
}

bool plx9054_card::memory_bit_test(DWORD bar, DWORD offset, DWORD bit_num)	const
{
	return	VISA32_PB_WRAPPER_DLL::memory_bit_test(card_res, bar, offset, bit_num);
}

void plx9054_card::memory_bit_toggle(DWORD bar, DWORD offset, DWORD bit_num)	const
{
	if (!VISA32_PB_WRAPPER_DLL::memory_bit_test(card_res, bar, offset, bit_num))
	{
		VISA32_PB_WRAPPER_DLL::memory_bit_set(card_res, bar, offset, bit_num);
	} 
	else
	{
		VISA32_PB_WRAPPER_DLL::memory_bit_clear(card_res, bar, offset, bit_num);
	}
}

void plx9054_card::memory_bit(DWORD bar, DWORD offset, DWORD bit_num, BOOL value)	const
{
	if (value)
	{
		VISA32_PB_WRAPPER_DLL::memory_bit_set(card_res, bar, offset, bit_num);
	} 
	else
	{
		VISA32_PB_WRAPPER_DLL::memory_bit_clear(card_res, bar, offset, bit_num);
	}
}

plx9054_card& plx9054_card::operator=(const plx9054_card &card)
{
	card_info::operator=(card);//在定义继承类的Operator=的时候
	//一定要调用调用父类的Operator=，这样不会出现子类的变量被赋值，而父类没有被赋值的情况
	this->bit_num	=	card.bit_num;
	this->card_res	=	card.card_res;
	this->eeprom_addr	=	card.eeprom_addr;
	this->health	=	card.health;
	this->visa_default	=	card.visa_default;

	return	*this;	//返回新对象本身
}

plx9054_card::plx9054_card(const plx9054_card &card)
{
	operator=(card);
}
