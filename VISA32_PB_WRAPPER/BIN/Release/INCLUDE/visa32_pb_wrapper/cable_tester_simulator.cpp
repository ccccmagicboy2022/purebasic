//
//
//  Generated by StarUML(tm) C++ Add-In
//
//  @ Project : VISA32_PB_WRAPPER_CLASS
//  @ File Name : cable_tester_simulator.cpp
//  @ Date : 2013/6/26
//  @ Author : cv
//
//

#include <iostream>
#include "cable_tester_simulator.h"
#include "visa/visa.h"

cable_tester_simulator::cable_tester_simulator() {

}

cable_tester_simulator::~cable_tester_simulator() {

}

bool cable_tester_simulator::init() {
	if (visa32_device::init())
	{
		viSetAttribute(get_device_res(), VI_ATTR_ASRL_BAUD, 115200);	//115200
		viSetAttribute(get_device_res(), VI_ATTR_ASRL_DATA_BITS, 8);	//8bit
		viSetAttribute(get_device_res(), VI_ATTR_ASRL_PARITY, VI_ASRL_PAR_ODD);	//奇校验
		viSetAttribute(get_device_res(), VI_ATTR_ASRL_STOP_BITS, VI_ASRL_STOP_ONE);//一位停止位
		viSetAttribute(get_device_res(), VI_ATTR_ASRL_FLOW_CNTRL,  VI_ASRL_FLOW_NONE);//无控制
		viSetAttribute(get_device_res(), VI_ATTR_TMO_VALUE, 5000);		//5s超时
		viSetAttribute(get_device_res(), VI_ATTR_ASRL_END_IN, VI_ASRL_END_NONE);
		viSetAttribute(get_device_res(), VI_ATTR_TERMCHAR_EN, VI_TRUE); //使用终止字符
		viSetAttribute(get_device_res(), VI_ATTR_TERMCHAR, 0x6F);		//使用0x6F为终止字符
		viSetBuf(get_device_res(), VI_IO_OUT_BUF, 0x8000);
		viInstallHandler(get_device_res(), VI_EVENT_ASRL_TERMCHAR, myCallback0, NULL);
		viEnableEvent(get_device_res(), VI_EVENT_ASRL_TERMCHAR, VI_HNDLR, VI_NULL);

		return	true;
	} 
	else
	{
		return	false;
	}
}

bool cable_tester_simulator::release() {
	viDisableEvent(get_device_res(), VI_ALL_ENABLED_EVENTS, VI_ALL_MECH);
	viUninstallHandler(get_device_res(), VI_EVENT_ASRL_TERMCHAR, myCallback0, NULL);
	return	visa32_device::release();
}

ViStatus	_VI_FUNCH cable_tester_simulator::myCallback0( ViSession vi, ViEventType etype, ViEvent eventContext, ViAddr userHandle )
{
	DWORD	rxd_count	=	0;
	DWORD	rxd_count_final	=	0;
	DWORD	txd_count_final	=	0;
	static	DWORD	callbackcount	=	0;
	COORD	count;
	unsigned	char*	rxd_buffer	=	new unsigned	char[1024]();
	unsigned	char*	txd_buffer	=	new unsigned	char[1024*10]();
	HANDLE hOut;
	
	viGetAttribute(vi, VI_ATTR_ASRL_AVAIL_NUM, &rxd_count);
	viRead(vi, (unsigned	char*)rxd_buffer, 6, &rxd_count_final);
	
	callbackcount	+=	1;
	count.Y	=	2;
	count.X	=	0;
	
	hOut = ::GetStdHandle(STD_OUTPUT_HANDLE);
	::SetConsoleCursorPosition(hOut, count);
	::SetConsoleTextAttribute(hOut, 0xB);	//天蓝	
	std::cout<<std::endl<<callbackcount<<"@"<<rxd_count<<"@"<<rxd_count_final<<std::endl;
	
	if (6	==	rxd_count_final)
	{
		if (0xA1	==	rxd_buffer[2])
		{
			txd_buffer[0]	=	0xEB;
			txd_buffer[1]	=	0x90;
			txd_buffer[2]	=	0xA1;
			txd_buffer[3]	=	0x00;
			txd_buffer[4]	=	0x14;
			txd_buffer[5]	=	0x6F;
			viWrite(vi, txd_buffer, 6, &txd_count_final);
		}
		else
		{
			txd_buffer[0]	=	0xEB;
			txd_buffer[1]	=	0x90;
			txd_buffer[5002]	=	0x14;
			txd_buffer[5003]	=	0x6F;
			for (size_t	i=2;i<5002;i++)
			{
				txd_buffer[i]	=	0x00;
			}
			txd_buffer[2]	=	0x01;	//
			txd_buffer[20]	=	0x44;
			txd_buffer[27]	=	0x02;	//
			txd_buffer[48]	=	0x01;
			txd_buffer[52]	=	0x04;	//
			txd_buffer[77]	=	0x08;	//
			txd_buffer[102]	=	0x10;	//
			txd_buffer[115]	=	0x01;
			txd_buffer[127]	=	0x20;	//
			txd_buffer[140]	=	0x02;
			txd_buffer[152]	=	0x20;	//
			txd_buffer[177]	=	0x20;	//
			viWrite(vi, txd_buffer, 5004, &txd_count_final);
		}
	}
	delete	[]	rxd_buffer;
	delete	[]	txd_buffer;
	return VI_SUCCESS;	
}